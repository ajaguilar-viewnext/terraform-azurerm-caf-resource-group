name: Integration test on Azure

on:
  # Trigger the workflow on push or pull request,
  # but only for the master branch
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  repository_dispatch:
  

env:
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID  }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET  }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID  }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID  }}
jobs:
  deploy-to-azure:
    runs-on: ubuntu-latest
    container:
      image: 'aztfmod/rover:2001.2205'
      options: --user 0
    steps:
    - uses: actions/checkout@v2
    - name: Terraform Validate
      run: |
        cd examples/rg_simple
        terraform init
        terraform validate -no-color
      shell: bash
    - name: Terraform Plan
      run: |
        cd examples/rg_simple
        terraform plan -no-color
      shell: bash
    - name: Terraform apply
      run: |
        cd examples/rg_simple
        terraform apply -no-color -auto-approve
      shell: bash
    - name: Install tooling
      run: |
        yum -y install wget
        wget https://dl.google.com/go/go1.13.linux-amd64.tar.gz
        tar -C /usr/local -xzf go1.13.linux-amd64.tar.gz
        az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
        az account set --subscription $ARM_SUBSCRIPTION_ID
        az extension add --name resource-graph
        sleep 69s
    - name: Terraform / Azure Integration test
      run: |
        export PATH=$PATH:/usr/local/go/bin
        cd test
        go get github.com/stretchr/testify
        go test
    - name: Terraform destroy
      run: |
        cd examples/rg_simple
        terraform destroy -no-color -auto-approve
      shell: bash
      if: always()
